name: Deploy Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'docker-compose.yml'
      - 'nginx/**'
      - '.github/workflows/deploy-infra.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch VPS public IP from Scaleway
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_ZONE: ${{ secrets.SCW_ZONE }}
          SCW_INSTANCE_ID: ${{ secrets.SCW_INSTANCE_ID }}
        run: |
          set -euo pipefail
          server_resp=$(curl -sS -w "\n%{http_code}" -H "X-Auth-Token: $SCW_SECRET_KEY" \
            "https://api.scaleway.com/instance/v1/zones/${SCW_ZONE}/servers/${SCW_INSTANCE_ID}")
          server_body=$(echo "$server_resp" | sed '$d')
          server_status=$(echo "$server_resp" | tail -n1)
          if [ "$server_status" != "200" ]; then
            echo "Scaleway server lookup failed (${server_status}): ${server_body}" >&2
            exit 1
          fi
          ip=$(echo "$server_body" | jq -r '.server.public_ip.address // .server.public_ips[0].address // empty')
          if [ -z "$ip" ] || [ "$ip" = "null" ]; then
            ips_resp=$(curl -sS -w "\n%{http_code}" -H "X-Auth-Token: $SCW_SECRET_KEY" \
              "https://api.scaleway.com/instance/v1/zones/${SCW_ZONE}/ips?server_id=${SCW_INSTANCE_ID}")
            ips_body=$(echo "$ips_resp" | sed '$d')
            ips_status=$(echo "$ips_resp" | tail -n1)
            if [ "$ips_status" != "200" ]; then
              echo "Scaleway IP lookup failed (${ips_status}): ${ips_body}" >&2
              exit 1
            fi
            ip=$(echo "$ips_body" | jq -r '.ips[0].address // empty')
          fi
          if [ -z "$ip" ] || [ "$ip" = "null" ]; then
            echo "Failed to resolve public IP" >&2
            exit 1
          fi
          echo "VPS_HOST=$ip" >> "$GITHUB_ENV"

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        env:
          SCW_SECRET_KEY: ${{ secrets.SCW_SECRET_KEY }}
          SCW_DEFAULT_ORGANIZATION_ID: ${{ secrets.SCW_DEFAULT_ORGANIZATION_ID }}
          SCW_DEFAULT_PROJECT_ID: ${{ secrets.SCW_DEFAULT_PROJECT_ID }}
        with:
          host: ${{ env.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          envs: SCW_SECRET_KEY,SCW_DEFAULT_ORGANIZATION_ID,SCW_DEFAULT_PROJECT_ID
          script: |
            export SCW_SECRET_KEY="${SCW_SECRET_KEY}"
            export SCW_DEFAULT_ORGANIZATION_ID="${SCW_DEFAULT_ORGANIZATION_ID}"
            export SCW_DEFAULT_PROJECT_ID="${SCW_DEFAULT_PROJECT_ID}"
            
            cd /app
            
            # Backup current config
            mkdir -p backups
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            cp docker-compose.yml backups/docker-compose.yml.$TIMESTAMP || true
            cp -r nginx backups/nginx.$TIMESTAMP || true
            
            echo "ğŸ“¥ Pulling latest infrastructure config from GitHub..."
            rm -rf /tmp/infra
            git clone --depth 1 https://github.com/Sillves/amare-wedding-infrastructure.git /tmp/infra
            
            # Copy new config
            echo "ğŸ“‹ Copying docker-compose.yml..."
            cp -v /tmp/infra/docker-compose.yml ./docker-compose.yml
            
            echo "ğŸ“‹ Copying nginx config..."
            rm -rf ./nginx
            mkdir -p ./nginx/conf.d
            cp -v /tmp/infra/nginx/nginx.conf ./nginx/nginx.conf
            cp -v /tmp/infra/nginx/conf.d/default.conf ./nginx/conf.d/default.conf
            
            echo "âœ… Files copied successfully"
            echo "Verifying files exist:"
            ls -la ./docker-compose.yml ./nginx/nginx.conf ./nginx/conf.d/default.conf
            
            # Verify docker-compose syntax
            echo "ğŸ” Validating docker-compose syntax..."
            docker-compose config > /dev/null || {
              echo "âŒ Invalid docker-compose.yml"
              cp backups/docker-compose.yml.$TIMESTAMP ./docker-compose.yml
              cp -r backups/nginx.$TIMESTAMP ./nginx
              exit 1
            }
            
            # Verify nginx syntax (one-off container to avoid dependency on running nginx)
            echo "ğŸ” Validating nginx syntax..."
            docker run --rm \
              -v /app/nginx/nginx.conf:/etc/nginx/nginx.conf:ro \
              -v /app/nginx/conf.d:/etc/nginx/conf.d:ro \
              nginx:alpine nginx -t || {
              echo "âŒ Invalid nginx config"
              cp backups/docker-compose.yml.$TIMESTAMP ./docker-compose.yml
              cp -r backups/nginx.$TIMESTAMP ./nginx
              exit 1
            }

            echo "ğŸš€ Pulling latest containers..."
            docker-compose pull
            
            echo "ğŸš€ Starting containers with secrets..."
            docker-compose up -d
            
            # Wait for containers to start
            sleep 5
            
            # Verify deployment
            echo "ğŸ“Š Deployment status:"
            docker-compose ps
            
            echo ""
            echo "ğŸ“‹ API logs (last 20 lines):"
            docker-compose logs api | tail -20
            
            echo ""
            echo "âœ… Infrastructure deployment successful!"

      - name: Notify deployment
        if: success()
        run: |
          echo "âœ… Infrastructure deployment successful!"
          echo "ğŸŒ Application: https://amare.wedding"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Infrastructure deployment failed!"
          echo "Check the logs above for details"
          exit 1


